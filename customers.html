<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <script src="https://kit.fontawesome.com/49caa8d480.js" crossorigin="anonymous"></script>
    
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <script src="js/user.js" type="text/javascript"></script>

    
    
    <title>Home</title>
</head>

<body>
    <main class="" id="main">
    <div class="container display-8">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="home.html"><img src="img/logo_nav_white.png" alt="ESM LOGO" width="120px"
                    /></a>
                    <label id="username">Username</label>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    </ul>
                    <form class="d-flex">
                        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                            <li class="nav-item dropdown ms-10">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-box-open"></i> &nbsp; Inventory
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="orders.html"><i class="fas fa-file-signature"></i> &nbsp; Orders</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="customers.html"><i class="fas fa-dolly"></i> &nbsp;customers</a></li>
                                    <li><a class="dropdown-item" href="products.html"><i class="fas fa-tachometer-alt"></i> &nbsp;Products</a></li>
                                </ul>
                            </li>
                            <li tabindex="2" class="nav-item  dropdown ms-10">
                                <a class="nav-link dropdown-toggle"role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-tags"></i> &nbsp; Sales
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="pos.html"><i class="fas fa-users"></i> &nbsp; POS</a></li>
                                    <li><a class="dropdown-item" href="sales.html"><i class="fas fa-users"></i> &nbsp; Sales Record</a></li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown ms-10">
                                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fas fa-tools"></i> &nbsp; Maintenance
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="employees.html"><i class="fas fa-users"></i> &nbsp; Employees</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="customers.html"><i class="fas fa-user-alt"></i> &nbsp;Customers</a></li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="reports.html"><i class="fas fas fa-chart-line"></i>&nbsp; Reports</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="index.html"><i class="fas fa-sign-out-alt"> </i>&nbsp;Logout</a>
                            </li>
                        </ul>
                    </form>
                </div>
            </div>
        </nav>
    </div>
    
    
    <div class="container pt-4">
        <nav aria-label="breadcrumb" class="breadcrumb d-flex justify-content-between">
            <ol class="breadcrumb">
              <li class="breadcrumb-item"><a href="home.html">Home</a></li>
              <li class="breadcrumb-item active" aria-current="page">Customers</li>
            </ol>
            <!-- <li class="btn-link help-popover" rel="popover" data-placement="bottom" data-title="Help Center" data-html="true" data-content="#"> <a href="#" >Help Center </a></li> -->
            <li class="btn-link"  onclick="toggleSidebar()"><a href="#">Help</a></li>
        </nav>
        <div class="row">
            <div class="col-sm">
                <h2 class="">Customers</h2>
            </div>
            <div class="col-sm">
             
            </div>
            <div class="col-sm text-alig">
             
            </div>
            <div class="col mb-9 float-right">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="clearProductFields();  $( '#btnSave' ).html('Add Customer');">
                    Add New Customer
                </button>
            </div>
        </div>
        
        <table id="customers" class="display compact table-striped" width="100%" ></table>
    </div>
    </main>
    <!-- Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Customer</h5>
            <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="customerFName" clas="bold">First Name</label><span id="err-customerFName" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="customerFName" placeholder="Customer First Name" required>
                        <div class="tooltip">
                            Eg. John
                          </div>
                        <input type="hidden" name="hdnIndex" id="hdnIndex">
                        
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="customerLName" clas="bold">Last Name</label><span id="err-customerLName" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="customerLName" placeholder="Customer Last Name" required>
                        <div class="tooltip">
                            Eg. Smith
                          </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="contact" class="bold">Contact Number</label><span id="err-contact" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="contact" placeholder="905 xxx - xxxx" required>
                        <div class="tooltip">
                            Eg. 905 123 4567
                          </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="address" class="bold">Address 1</label><span id="err-address" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="address" placeholder="Street address or PO BOX" required>
                        <div class="tooltip">
                            Eg. 123 Lundys Lane
                          </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="address2" class="bold">Address 2</label>
                        <input type="text" class="form-control" id="address2" placeholder="Apt, Suite, Unit, Building" required>
                        <div class="tooltip">
                            Eg. Unit 5
                          </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="city" class="bold">City</label><span id="err-city" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="city" placeholder="eg. Niagara Falls" required>
                        <div class="tooltip">
                            Eg. Niagara Falls
                          </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="province" clas="bold">Province</label>
                        <input type="text" class="form-control" id="province" placeholder="Ontario" disabled>
                        <!-- <select name="province" id="province" class="form-control  form-select" disabled>
                            <option value="0">SELECT PROVINCE</option>
                            <option value="AB">Alberta</option>
                            <option value="BC">British Columbia</option>
                            <option value="MB">Manitoba</option>
                            <option value="NB">New Brunswick</option>
                            <option value="NL">Newfoundland and Labrador</option>
                            <option value="NS">Nova Scotia</option>
                            <option value="NT">Northwest Territories</option>
                            <option value="NU">Nunavut</option>
                            <option value="ON">Ontario</option>
                            <option value="PE">Prince Edward Island</option>
                            <option value="QC">Quebec</option>
                            <option value="SK">Saskatchewan</option>
                            <option value="YT">Yukon</option>
                        </select> -->
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm">
                    <div class="form-group col-md">
                        <label for="postal" class="bold">Postal</label><span id="err-postal" class="d-none">*This field is required</span>
                        <input type="text" class="form-control" id="postal" placeholder="X0X-0X0" required>
                        <div class="tooltip">
                            Eg. L0S 1J0
                          </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearFields();">Close/Disregard</button>
            <button type="button" class="btn btn-primary" id="btnSave">Save changes</button>
            </div>
        </div>
        </div>
    </div>
    </div>
    <!-- SideBar Help -->
    <!-- <div class="sidebar-tab" id="sidebar-tab">
    <div class="vertical-text text-center" id="sidebar-tab-text" onclick="toggleSidebar()"><span class="arrow vertical-text"></span>CLICK TO VIEW HELP<span class="arrow vertical-text"></span></div> -->
  </div>
  <div class="sidebar" id="sidebar">
    <div class="container-liner">
      <h4>CUSTOMERS Page</h4>
      <div>This is the <b>Customers</b> page where you can navigate by pointing and clicking your mouse or tabbing using your keyboard and enter key. <br><br>
      <b>ADD NEW CUSTOMER</b> click this option to open a new popup form where you can input customer details. <br><br>
      <b>SHOW ENTRIES</b> additional filter you can set based on number of records: 10, 25, 50, 100. <br><br>
      <b>SEARCH</b> input a valid customer name to filter, functionality work in progress. <br><br> 
      <b>TABLE</b> you can sort the records by clicking the Customer Name, Contact, City (hover mouse for complete address). <br><br>
      <b>EDIT</b> click this option to navigate to another page where you can modify an existing customer. <br> <br>
      <b>DELETE</b> click this button to delete a customer. <br><br> 
      <b>PREVIOUS/NEXT</b> you can select the paging based on number of available records.</div>
    </div>
  </div>
</body>
</html>
<script>

// sidebar Help
$(function(){
  $("#sidebar-tab-text").width($("#sidebar").height());
});
$( window ).resize(function() {
  $("#sidebar-tab-text").width($("#sidebar").height());
});
/* End of unsure centering */

//The only necessary piece of code
function toggleSidebar(){
  $("#sidebar").toggleClass("move-to-left");
  $("#sidebar-tab").toggleClass("move-to-left");
  $("main").toggleClass("move-to-left-partly");
  $(".arrow").toggleClass("active");
}


// //helpcenter
// $(document).ready(function() {
//   $('.help-popover').popover({
//     placement: 'bottom',
//     title: 'CUSTOMERS PAGE',
//     html: true,
//     content: "This is the <b>Customers</b> page where you can navigate by pointing and clicking your mouse or tabbing using your keyboard and enter key. </br></br> <b>ADD NEW CUSTOMER</b> click this option to open a new popup form where you can input customer details. </br></br> <b>SHOW ENTRIES</b> additional filter you can set based on number of records: 10, 25, 50, 100. </br></br> <b>SEARCH</b> input a valid customer name to filter, functionality work in progress. </br></br> <b>TABLE</b> you can sort the records by clicking the Customer Name, Contact, City (hover mouse for complete address). </br></br> <b>EDIT</b> click this option to navigate to another page where you can modify an existing customer. </br></br> <b>DELETE</b> click this button to delete a customer. </br></br> <b>PREVIOUS/NEXT</b> you can select the paging based on number of available records."
//   });
// //   $(document).on("click", ".popover .close" , function(){
// //         $(this).parents(".popover").popover('hide');
// //     });
// });


//Tooltip
tipTool("customerFName");
tipTool("customerLName");
tipTool("contact");
tipTool("address");
tipTool("address2");
tipTool("city");
tipTool("postal");



//HelpModal
$(".modal").draggable({
  handle: ".modal-header"
});


var table;
let  dataSet =[];
if (localStorage.getItem("customerList") != null || localStorage.getItem("customerList") != [] || localStorage.getItem("customerList") != undefined) 
    //localStorage.removeItem("customerList");

var cities = ['Barrie',
'Belleville',
'Brampton',
'Brant',
'Brantford',
'Brockville',
'Burlington',
'Cambridge',
'Clarence-Rockland',
'Cornwall',
'Dryden',
'Elliot Lake',
'Greater Sudbury',
'Guelph',
'Haldimand County',
'Hamilton',
'Kawartha Lakes',
'Kenora',
'Kingston',
'Kitchener',
'London',
'Markham',
'Mississauga',
'Niagara Falls',
'Norfolk County',
'North Bay',
'Orillia',
'Oshawa',
'Ottawa',
'Owen Sound',
'Pembroke',
'Peterborough',
'Pickering',
'Port Colborne',
'Prince Edward County',
'Quinte West',
'Richmond Hill',
'Sarnia',
'Sault Ste. Marie',
'St. Catharines',
'St. Thomas',
'Stratford',
'Temiskaming Shores',
'Thorold',
'Thunder Bay',
'Timmins',
'Toronto',
'Vaughan',
'Waterloo]',
'Welland',
'Windsor',
'Woodstock'
];

arr = ['customerFName','customerLName','contact','address', 'city', 'postal'];



//new validation
function validateForm()
{
    let err = 0;
    let msg = "Error: \n";
    arr.forEach(element => {
        let e = $('#'+element);
        let ee =  $('#err-'+element);
        if(e.val()=="")
        {
            e.addClass('error');
            //e.attr('role','alert');
            ee.removeClass('d-none');
            //e.val('*this is required');
           // e.attr("placeholder", "This is required");
            err = 1;
        }
    });
    if(err == 0){
        arr.forEach(element => {
            let e = $('#'+element);
            let ee =  $('#err-'+element);
            e.removeClass('error');
            ee.addClass('d-none');
        });
    }

    return err;
}
function clearFields()
{
    arr.forEach(element => {
            let e = $('#'+element);
            let ee =  $('#err-'+element);
            e.removeClass('error');
            ee.addClass('d-none');
        });
}
// function validateForm()
// {
//     let fName = $("#customerFName")
//     let lName = $("#customerLName")
//     let contact = $("#contact")
//     let address = $("#address1")
//     let city = $("#city")
//     let province = $("#province")
//     let postalCode = $("#postal")
//     let err = 0;
//     let msg = "Error: \n";
//     if(fName.val() == "")
//     {
//         fName.addClass('error');
//         msg += "First Name is required \n";
//         err = 1;
//     }
//     if (lName.val() == "" )
//     {
//         lName.addClass('error');
//         msg += "Last Name is required \n";
//         err = 1;
//     }
//     if ( contact.val() == "")
//     {
//         contact.addClass('error');
//         msg += "Please enter a phone number \n";
//         err = 1;
//     }
//     if ( address.val() == "")
//     {
//         address.addClass('error');
//         msg += "Please enter an address\n";
//         err = 1;
//     }
//     if ( city.val() == "")
//     {
//         city.addClass('error');
//         msg += "Please enter a city \n";
//         err = 1;
//     }
//     if ( province.val() == "")
//     {
//         province.addClass('error');
//         msg += "Please select a province \n";
//         err = 1;
//     }
//     if ( postalCode.val() == "")
//     {
//         postalCode.addClass('error');
//         msg += "Please enter a correct postal code\n";
//         err = 1;
//     }
//     if(err == 0){
//         fName.removeClass('error');
//         lName.removeClass('error');
//         contact.removeClass('error');
//         address.removeClass('error');
//         city.removeClass('error');
//         province.removeClass('error');
//         postalCode.removeClass('error');
//     }
//     else
//     {
//         alert(msg);
//     }
//     return err;
// }


function randomNumberID(){
    return Math.floor(Math.random()*(1000002 - 1 + 1)) + 1;
}

function getItems() {
    dataSet.length = 0;
    let customerList = JSON.parse(localStorage.getItem("customerList"));
    console.log(customerList);
    if(customerList)
    {
        for (let i = 0; i < customerList.length; i++){
            let temp = {
                custID: customerList[i].custID,
                customerFName: customerList[i].customerFName,
                customerLName: customerList[i].customerLName,
                fullName: customerList[i].fullName,
                contact: customerList[i].contact,
                address: customerList[i].address,
                address2: customerList[i].address2,
                city:  customerList[i].city,
                province: customerList[i].province,
                postal: customerList[i].postal,
                fullAddress: customerList[i].fullAddress
            };
            dataSet.push(temp);
           
        }
    } 
}
$(document).ready(function () {
    $( "#city" ).autocomplete({
            source: cities
        });

    getItems();
    const inputElement = document.getElementById('contact');
    inputElement.addEventListener('keydown',enforceFormat);
    inputElement.addEventListener('keyup',formatToPhone);

    table = $('#customers').DataTable({
        language:{searchPlaceholder:"Eg. John Smith"},
        data: dataSet,
        "columns": [
            {title: 'custID',data: "custID" },
            { title: 'Customer Name',data: "fullName" },
            { title: 'Contact', data: "contact" },
            { title: "City", data: "city", "orderable": true, "render": function(data, type, row) {return '<a  title="'+row.address+' '+row.address2+' '+row.city+' '+row.province+' '+row.postal+'" data-toggle="tooltip">'+data+'</a>'} },
            { title: 'Action' },
        ],
        columnDefs: [
            {
                targets: -1,
                data: null,
                defaultContent: '<button type="button" class="btn btn-primary btn-xs" id="edit-btn">Edit</button>  <button type="button" class="btn btn-danger btn-xs" id="del-btn">Delete</button>'
            },
            {
                target: 0,
                visible: false,
            },
            { orderable: false, searchable: false, targets: -1 }
        ], 
    });
    //delete
    $('#customers tbody').on('click', "#del-btn", function() {
        var row = $(this).parents('tr')[0];
        var data = table.row(row).data();
        let confirmAction = confirm("Are you sure to Delete Customer: "+data['fullName']+"?");
        if (confirmAction) {
            alert("Customer Deleted");
            let customerList = JSON.parse(localStorage.getItem("customerList"));
            for(let i = 0; i < customerList.length; i++){
                if (customerList[i].custID === data['custID']) {
                    customerList.splice(i,1);
                }
            }
            localStorage.setItem("customerList", JSON.stringify(customerList)); //reset the values in the local storage
        } 
        getItems();
        remakeDT();
    });
    //edit
    $('#customers tbody').on('click', "#edit-btn", function() {
        clearProductFields();
        $('#productModal').modal('show');
        var row = $(this).parents('tr')[0];
        var data = table.row(row).data();
    
        let customerList = JSON.parse(localStorage.getItem("customerList"));
       
        for (let i = 0; i < customerList.length; i++) {
            if (customerList[i].custID === data['custID']) {
                $("#customerFName").val(customerList[i].customerFName);
                $("#customerLName").val(customerList[i].customerLName);
                $("#contact").val(customerList[i].contact);
                $("#address").val(customerList[i].address);
                $("#address2").val(customerList[i].address2);
                $("#city").val(customerList[i].city);
                $("#province").val(customerList[i].province);
                $("#postal").val(customerList[i].postal);
            }
        }
        $("#hdnIndex").val(data['custID']);
        $( "#btnSave" ).html('Update Customer');
       
    });
    //save items
    $( "#btnSave" ).click(function() {
        if(!validateForm())
        {
            $('#productModal').modal('toggle');
            $( "#btnSave" ).html('Add Customer');
            var index = $("#hdnIndex");
            //perform add if the hidden value is empty
            if (index.val() == '')
            {
                addItem();
            }
            else{
                addItem();
                let customerList = JSON.parse(localStorage.getItem("customerList"));
                //Delete from the storage
                for(let i = 0; i < customerList.length; i++){
                    if(customerList[i].custID === index.val())
                    {
                        customerList.splice(i,1);
                    }
                }
                localStorage.setItem("customerList", JSON.stringify(customerList));
                alert("Customer has been updated!");
            }

            index.val('');
            getItems();
            remakeDT();
            clearProductFields();
        }
        
    });
});   

function addItem()
{
    const custID = randomNumberID() + $("#customerFName").val()+ $("#customerLName").val() + randomNumberID();

    let newDs = {
        custID: custID,
        customerFName: $("#customerFName").val().toUpperCase(),
        customerLName: $("#customerLName").val().toUpperCase(),
        fullName: $("#customerFName").val().toUpperCase() + ' '+$("#customerLName").val().toUpperCase(),
        contact: $("#contact").val(),
        address: $("#address").val(),
        address2: $("#address2").val(),
        city: $("#city").val(),
        province: $("#province").val(),
        postal: $("#postal").val(),
    };
    if (localStorage.getItem("customerList") === null || localStorage.getItem("customerList") === [] || localStorage.getItem("customerList") === undefined) 
    {
        let customerList = [];
        customerList.push(newDs);
        localStorage.setItem("customerList", JSON.stringify(customerList));
    } 
    else
    {
        let customerList = JSON.parse(localStorage.getItem("customerList"));
        customerList.push(newDs);
        localStorage.setItem("customerList", JSON.stringify(customerList));
    }
    //dataSet.push(newDs);
}
function remakeDT()
{
    $('#customers').DataTable().clear();
    $('#customers').DataTable().destroy();
    table = $('#customers').DataTable({
        language:{searchPlaceholder:"Eg. John Smith"},
        data: dataSet,
        "columns": [
            {title: 'custID',data: "custID" },
            { title: 'Customer Name',data: "fullName" },
            { title: 'Contact', data: "contact" },
            { title: 'City', data: "city" },
            { title: 'Action' },
        ],
        columnDefs: [
            {
                targets: -1,
                data: null,
                defaultContent: '<button type="button" class="btn btn-primary btn-xs" id="edit-btn">Edit</button>  <button type="button" class="btn btn-danger btn-xs" id="del-btn">Delete</button>'
            },
            {
                target: 0,
                visible: false,
            },
            { orderable: false, searchable: false, targets: -1 }
        ], 
    });
}

function clearProductFields()
{
    $("#customerFName").val('');
    $("#customerLName").val('');
    $("#contact").val('');
    $("#address").val('');
    $("#address2").val('');
    $("#city").val('');
    $("#province").val('');
    $("#postal").val('');
}
const loginUser = user.map(({ username }) => username);
  document.getElementById("username").innerHTML = "Hello " + loginUser + "!";
</script>
